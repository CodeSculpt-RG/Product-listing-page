<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Commerce Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Custom styles for star rating and product details images if needed */
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .star-rating input[type="radio"] {
            display: none;
        }

        .star-rating label {
            font-size: 2rem;
            /* Adjust size as needed */
            color: #ddd;
            cursor: pointer;
            padding: 0 0.1em;
        }

        .star-rating input[type="radio"]:checked~label,
        .star-rating label:hover,
        .star-rating label:hover~label {
            color: #ffd700;
        }

        #product-details-images img {
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }

        #product-details-images img:hover {
            border-color: #3b82f6;
            /* Tailwind blue-500 */
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Ensure hidden class works as expected */
        .hidden {
            display: none !important;
        }

        /* Custom styles for better modal appearance */
        .modal-content {
            border-radius: 0.5rem;
            /* Rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            /* Shadow */
        }

        /* Custom styles for user dropdown */
        #user-dropdown {
            right: 0;
            /* Align dropdown to the right of the button */
            top: 100%;
            /* Position below the button */
            margin-top: 0.5rem;
            /* Spacing below button */
            border-radius: 0.5rem;
            /* Rounded corners */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            /* Shadow */
            min-width: 12rem;
            /* Minimum width */
        }

        /* Ensure product details modal is full screen on small devices */
        #product-details {
            /* Override fixed positioning for better mobile scrolling if needed,
               but fixed inset-0 with overflow-y-auto inside content is usually better */
        }

        /* Responsive header adjustments */
        @media (max-width: 767px) {

            /* Bootstrap's small breakpoint */
            #header-controls {
                flex-direction: column;
                /* Stack items vertically */
                align-items: center;
                /* Center items horizontally in the column */
                gap: 0.75rem;
                /* Add some space between stacked items */
            }

            #search-input {
                width: 100%;
                /* Make search bar full width */
            }

            #cart-container,
            #user-profile-container {
                width: auto;
                /* Allow cart and profile containers to size based on content */
                align-self: flex-end;
                /* Align to the right within the column */
            }

            /* Refine alignment for the logo on small screens */
            header .container>h1 {
                width: 100%;
                /* Make header title take full width */
                text-align: center;
                /* Center the title */
                margin-bottom: 1rem;
                /* Add space below the title */
            }

            header .container {
                flex-direction: column;
                align-items: center;
            }

            #header-controls {
                width: 100%;
                /* Ensure controls take full width */
            }

            #cart-dropdown,
            #user-dropdown {
                left: auto;
                /* Keep default left alignment for dropdowns */
                right: 0;
                /* Align dropdowns to the right */
                width: auto;
                /* Allow dropdown width to adjust */
                min-width: 12rem;
                /* Maintain minimum width */
            }
        }
    </style>
</head>

<body class="bg-gray-100 font-inter">
    <div id="root">
        <header class="bg-white shadow-md py-4 fade-in">
            <div class="container mx-auto flex flex-wrap items-center justify-between px-4">
                <h1 id="main-header-title" class="text-2xl font-bold text-gray-900 mb-2 md:mb-0">E-Commerce Store</h1>
                <div id="header-controls" class="flex items-center gap-4 flex-grow justify-end">
                    <input type="text" placeholder="Search products..." class="w-full md:w-64 border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500" id="search-input" />
                    <div id="cart-container" class="relative">
                        <button class="relative bg-white border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z" />
                            </svg>
                            <span id="cart-item-count" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full text-xs w-5 h-5 flex items-center justify-center border border-white">0</span>
                        </button>
                        <div id="cart-dropdown" class="absolute right-0 mt-2 w-80 bg-white border border-gray-200 shadow-xl rounded-md z-20 max-h-[500px] overflow-y-auto hidden">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="text-lg font-semibold">Your Cart</h3>
                            </div>
                            <div id="cart-items-container" class="p-4 space-y-2">
                                <p class="text-gray-500">Your cart is empty.</p>
                            </div>
                            <div class="p-4 border-t border-gray-200">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Total:</span>
                                    <span id="cart-total-price" class="text-lg font-bold">₹0.00</span>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button id="checkout-button" class="w-full bg-green-500 text-white rounded-md py-2 hover:bg-green-600 transition-colors">Checkout</button>
                                    <button id="clear-cart-button" class="w-full border border-gray-300 rounded-md py-2 hover:bg-gray-100 transition-colors">Clear Cart</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="user-profile-container" class="relative">
                        <button id="auth-button" class="bg-blue-500 text-white rounded-md py-2 px-4 hover:bg-blue-600 transition-colors flex items-center gap-2" data-bs-toggle="modal" data-bs-target="#authModal">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0zM12 14a7 7 0 0 0-7 7h14a7 7 0 0 0-7-7z" />
                            </svg>
                            Sign In / Up
                        </button>
                        <div id="user-dropdown" class="absolute right-0 mt-2 w-48 bg-white border border-gray-200 shadow-md rounded-md z-20 hidden">
                            <div class="p-4 border-b border-gray-200">
                                <h3 id="user-name" class="text-lg font-semibold text-gray-800 truncate"></h3>
                                <p id="user-email" class="text-sm text-gray-500 truncate"></p>
                            </div>
                            <div class="p-2">
                                <button id="signout-button" class="w-full text-left hover:bg-gray-100 rounded-md py-2 px-3 flex items-center gap-2 text-gray-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 0 1-3 3H3a3 3 0 0 1-3-3v-1m0 0v-1c0-1.791 1.39-3.258 3.13-3.258h3.74c1.74 0 3.13 1.467 3.13 3.258v1" />
                                    </svg>
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main id="main-product-listing-view" class="container mx-auto py-8 px-4">
            <div id="product-list" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
            </div>
            <div id="no-products" class="text-gray-500 text-center py-12 hidden">
                No products found matching your search.
            </div>
            <div id="pagination-container" class="flex justify-center mt-8 space-x-2">
            </div>
        </main>

        <div id="customer-details-view" class="hidden">
            <main class="container mx-auto py-8 px-4">
                <h2 class="text-3xl font-semibold text-gray-800 mb-6 text-center">Enter Your Details</h2>
                <div class="max-w-2xl mx-auto">
                    <div id="customer-details-form" class="bg-white p-6 rounded-md shadow-md mb-6">
                        <h3 class="text-xl font-medium mb-4 text-gray-700">Shipping Information</h3>
                        <form id="shipping-info-form" class="space-y-4">
                            <div class="mb-3">
                                <label for="customer-name" class="form-label">Full Name</label>
                                <input type="text" id="customer-name" class="form-control" placeholder="Enter your full name" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-houseno" class="form-label">House/Flat Number</label>
                                <input type="text" id="customer-houseno" class="form-control" placeholder="Enter house or flat number" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-address" class="form-label">Street Address</label>
                                <input type="text" id="customer-address" class="form-control" placeholder="Enter your street address" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-locality" class="form-label">Locality</label>
                                <input type="text" id="customer-locality" class="form-control" placeholder="Enter your locality" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-district" class="form-label">District</label>
                                <input type="text" id="customer-district" class="form-control" placeholder="Enter your district" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-state" class="form-label">State</label>
                                <input type="text" id="customer-state" class="form-control" placeholder="Enter your state" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-pincode" class="form-label">Pincode</label>
                                <input type="text" id="customer-pincode" class="form-control" placeholder="Enter your pincode" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-phone" class="form-label">Phone Number (Main)</label>
                                <input type="tel" id="customer-phone" class="form-control" placeholder="Enter your phone number" required>
                            </div>
                            <div class="mb-3">
                                <label for="customer-altphone" class="form-label">Alternate Phone Number (Optional)</label>
                                <input type="tel" id="customer-altphone" class="form-control" placeholder="Enter alternate phone number (optional)">
                            </div>

                            <div id="shipping-form-error" class="mt-2 text-danger text-sm hidden"></div>
                            <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-md hover:bg-blue-600 text-lg font-medium">Proceed to Order Summary</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>


        <div id="order-summary-view" class="hidden">
            <main class="container mx-auto py-8 px-4">
                <h2 class="text-3xl font-semibold text-gray-800 mb-6 text-center">Order Summary</h2>
                <div class="max-w-2xl mx-auto">
                    <div id="customer-summary-details" class="bg-white p-6 rounded-md shadow-md mb-6">
                        <h3 class="text-xl font-medium mb-4 text-gray-700">Shipping Information</h3>
                        <p><span class="font-semibold">Name:</span> <span id="summary-customer-name"></span></p>
                        <p><span class="font-semibold">House/Flat No:</span> <span id="summary-customer-houseno"></span></p>
                        <p><span class="font-semibold">Street Address:</span> <span id="summary-customer-address"></span></p>
                        <p><span class="font-semibold">Locality:</span> <span id="summary-customer-locality"></span></p>
                        <p><span class="font-semibold">District:</span> <span id="summary-customer-district"></span></p>
                        <p><span class="font-semibold">State:</span> <span id="summary-customer-state"></span></p>
                        <p><span class="font-semibold">Pincode:</span> <span id="summary-customer-pincode"></span></p>
                        <p><span class="font-semibold">Phone (Main):</span> <span id="summary-customer-phone"></span></p>
                        <p><span class="font-semibold">Phone (Alt):</span> <span id="summary-customer-altphone"></span></p>

                        <button id="edit-shipping-info" class="mt-4 text-blue-600 hover:underline text-sm">Edit Information</button>
                    </div>

                    <div class="bg-white p-6 rounded-md shadow-md mb-6">
                        <h3 class="text-xl font-medium mb-4 text-gray-700">Items in Your Order</h3>
                        <div id="order-items-summary" class="space-y-4">
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-md shadow-md">
                        <h3 class="text-xl font-medium mb-4 text-gray-700">Order Details</h3>
                        <div class="flex justify-between mb-2 text-gray-700">
                            <span>Subtotal:</span>
                            <span id="summary-subtotal">₹0.00</span>
                        </div>
                        <div class="flex justify-between mb-2 text-gray-700">
                            <span>Tax (5%):</span>
                            <span id="summary-tax">₹0.00</span>
                        </div>
                        <div class="flex justify-between font-semibold text-lg text-gray-900 mt-2 pt-2 border-t">
                            <span>Total:</span>
                            <span id="summary-total">₹0.00</span>
                        </div>
                        <div class="mt-6 flex flex-col sm:flex-row gap-4">
                            <button id="continue-shopping-btn" class="w-full sm:w-auto bg-gray-500 text-white py-3 px-6 rounded-md hover:bg-gray-600 text-lg font-medium order-2 sm:order-1">Continue Shopping</button>
                            <button id="proceed-to-payment-btn" class="w-full bg-green-500 text-white py-3 rounded-md hover:bg-green-600 text-lg font-medium flex-grow order-1 sm:order-2">Proceed to Payment (Mock)</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>


        <footer class="bg-gray-200 py-4 mt-12">
            <div class="container mx-auto text-center text-gray-600 px-4">
                &copy; 2024 E-Commerce Store. All rights reserved.
            </div>
        </footer>

        <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="authModalLabel">Sign In</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="auth-form" class="space-y-3">
                            <div class="mb-3" id="name-group" style="display: none;">
                                <label for="auth-name" class="form-label">Name</label>
                                <input type="text" id="auth-name" class="form-control" placeholder="Enter your name">
                            </div>
                            <div class="mb-3">
                                <label for="auth-email" class="form-label">Email address</label>
                                <input type="email" id="auth-email" class="form-control" placeholder="Enter your email" required>
                            </div>
                            <div class="mb-3">
                                <label for="auth-password" class="form-label">Password</label>
                                <input type="password" id="auth-password" class="form-control" placeholder="Enter your password" required>
                            </div>
                            <div id="auth-error" class="mt-2 text-danger text-sm hidden"></div>
                            <button type="submit" class="btn btn-primary w-100" id="auth-submit">Sign In</button>
                        </form>
                        <div class="mt-3 text-center">
                            <button id="auth-toggle" class="btn btn-link">Need an account? Sign Up</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="product-details" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
            <div id="product-details-content" class="relative p-6 rounded-md shadow-2xl bg-white max-w-3xl w-full max-h-[90vh] overflow-y-auto flex flex-col md:flex-row gap-6">
                <button id="product-details-close" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="w-full md:w-1/2">
                    <img id="product-details-main-image" src="" alt="Selected product image" class="w-full h-auto max-h-96 object-contain rounded-md mb-4" onerror="this.onerror=null; this.src='https://placehold.co/300x300/E5E7EB/4B5563?text=Image+Not+Available';">
                    <div id="product-details-images" class="flex gap-2 overflow-x-auto">
                    </div>
                </div>
                <div class="w-full md:w-1/2">
                    <h2 id="product-details-title" class="text-2xl font-semibold mb-2">Product Title</h2>
                    <p id="product-details-description" class="text-gray-700 mb-4 text-sm"></p>
                    <p id="product-details-price" class="text-xl font-bold text-blue-600 mb-4"></p>
                    <div class="flex items-center gap-4 mb-4">
                        <span class="text-gray-700 font-medium">Rating: <span id="product-details-rating"></span></span>
                        <span class="text-gray-700">Sold By: <span id="product-details-seller">Example Seller</span></span>
                    </div>
                    <div class="mt-4 mb-4">
                        <button onclick="addToCart(productDetails)" class="w-full bg-green-500 text-white rounded-md py-2 px-4 hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z" />
                            </svg>
                            Add to Cart
                        </button>
                    </div>
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold mb-2">Reviews</h4>
                        <div id="product-details-reviews" class="space-y-2 max-h-40 overflow-y-auto">
                            <p class="text-gray-500 text-sm">No reviews yet.</p>
                        </div>
                    </div>
                    <div class="review-input-container border-t pt-4">
                        <h4 class="text-md font-semibold mb-2">Write a review</h4>
                        <textarea id="review-input" class="w-full border border-gray-300 rounded-md p-2 text-sm" placeholder="Share your thoughts..."></textarea>
                        <div class="star-rating mt-2 mb-2">
                            <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars">★</label>
                            <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars">★</label>
                            <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars">★</label>
                            <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars">★</label>
                            <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star">★</label>
                        </div>
                        <button id="submit-review-button" class="w-full bg-blue-500 text-white rounded-md py-2 px-4 hover:bg-blue-600 transition-colors text-sm">Submit Review</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API Base URL
        const API_BASE_URL = 'https://fakestoreapi.com';

        // State Variables
        let products = [];
        let cartItems = [];
        let user = null; // Stores logged-in user info
        let productDetails = null; // Stores details of the currently viewed product
        let currentPage = 1;
        let searchTerm = '';
        let totalPages = 0;
        const productsPerPage = 12; // Number of products to display per page
        let selectedRating = 0; // For product reviews
        let customerInfo = null; // Stores customer details

        // DOM Elements
        const productListContainer = document.getElementById('product-list');
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalPriceElement = document.getElementById('cart-total-price');
        const cartContainer = document.getElementById('cart-container');
        const cartDropdown = document.getElementById('cart-dropdown');
        const authButton = document.getElementById('auth-button'); // Sign In / Up button
        const authForm = document.getElementById('auth-form'); // Auth modal form
        const nameGroup = document.getElementById('name-group'); // Name input group (for Sign Up)
        const authNameInput = document.getElementById('auth-name');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitButton = document.getElementById('auth-submit'); // Submit button in modal
        const authModalLabel = document.getElementById('authModalLabel'); // Modal title
        const authToggle = document.getElementById('auth-toggle'); // Button to switch between Sign In/Up
        const userDropdown = document.getElementById('user-dropdown'); // Dropdown for logged-in user
        const userNameElement = document.getElementById('user-name');
        const userEmailElement = document.getElementById('user-email');
        const signOutButton = document.getElementById('signout-button');
        const cartItemCountElement = document.getElementById('cart-item-count');
        const checkoutButton = document.getElementById('checkout-button');
        const clearCartButton = document.getElementById('clear-cart-button');
        const searchInput = document.getElementById('search-input');
        const noProductsMessage = document.getElementById('no-products');
        const paginationContainer = document.getElementById('pagination-container');
        const productDetailsElement = document.getElementById('product-details'); // Product details modal/view
        const productDetailsCloseButton = document.getElementById('product-details-close');
        const productDetailsImagesContainer = document.getElementById('product-details-images'); // Thumbnail images
        const productDetailsMainImage = document.getElementById('product-details-main-image'); // Main product image
        const productDetailsTitleElement = document.getElementById('product-details-title');
        const productDetailsDescriptionElement = document.getElementById('product-details-description');
        const productDetailsPriceElement = document.getElementById('product-details-price');
        const productDetailsRatingElement = document.getElementById('product-details-rating');
        const productDetailsSellerElement = document.getElementById('product-details-seller'); // Placeholder
        const productDetailsReviewsContainer = document.getElementById('product-details-reviews'); // Reviews list
        const reviewInput = document.getElementById('review-input'); // Review textarea
        const submitReviewButton = document.getElementById('submit-review-button'); // Submit review button
        const starRatingInputs = document.querySelectorAll('.star-rating input[type="radio"]'); // Star rating inputs

        // View Management DOM Elements
        const mainHeaderTitle = document.getElementById('main-header-title');
        const headerControls = document.getElementById('header-controls'); // Container for search, cart, profile
        const mainProductListingView = document.getElementById('main-product-listing-view'); // Main product list area
        const customerDetailsView = document.getElementById('customer-details-view'); // Customer details area (NEW)
        const orderSummaryView = document.getElementById('order-summary-view'); // Order summary area

        // Customer Details DOM Elements (NEW)
        const shippingInfoForm = document.getElementById('shipping-info-form');
        const customerNameInput = document.getElementById('customer-name');
        const customerHouseNoInput = document.getElementById('customer-houseno'); // NEW
        const customerAddressInput = document.getElementById('customer-address');
        const customerLocalityInput = document.getElementById('customer-locality');
        const customerDistrictInput = document.getElementById('customer-district'); // NEW
        const customerStateInput = document.getElementById('customer-state');
        const customerPincodeInput = document.getElementById('customer-pincode'); // NEW
        const customerPhoneInput = document.getElementById('customer-phone'); // NEW
        const customerAltPhoneInput = document.getElementById('customer-altphone'); // NEW
        const shippingFormError = document.getElementById('shipping-form-error');


        // Order Summary DOM Elements
        const customerSummaryDetails = document.getElementById('customer-summary-details'); // Customer details in summary (NEW)
        const summaryCustomerNameEl = document.getElementById('summary-customer-name'); // Customer name in summary (NEW)
        const summaryCustomerHouseNoEl = document.getElementById('summary-customer-houseno'); // NEW
        const summaryCustomerAddressEl = document.getElementById('summary-customer-address'); // Customer address in summary (NEW)
        const summaryCustomerLocalityEl = document.getElementById('summary-customer-locality'); // Customer locality in summary (NEW)
        const summaryCustomerDistrictEl = document.getElementById('summary-customer-district'); // NEW
        const summaryCustomerStateEl = document.getElementById('summary-customer-state'); // Customer state in summary (NEW)
        const summaryCustomerPincodeEl = document.getElementById('summary-customer-pincode'); // NEW
        const summaryCustomerPhoneEl = document.getElementById('summary-customer-phone'); // NEW
        const summaryCustomerAltPhoneEl = document.getElementById('summary-customer-altphone'); // NEW

        const editShippingInfoBtn = document.getElementById('edit-shipping-info'); // Edit button in summary (NEW)

        const orderItemsSummaryContainer = document.getElementById('order-items-summary');
        const summarySubtotalEl = document.getElementById('summary-subtotal');
        const summaryTaxEl = document.getElementById('summary-tax');
        const summaryTotalEl = document.getElementById('summary-total');
        const continueShoppingBtn = document.getElementById('continue-shopping-btn');
        const proceedToPaymentBtn = document.getElementById('proceed-to-payment-btn');


        // Helper function to format currency (Updated for INR)
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        };


        // --- Product Listing Functions ---

        // Render products based on search term and current page
        const renderProducts = (currentSearchTerm, page) => {
            let filteredProducts = products;
            // Apply search filter if a search term is provided
            if (currentSearchTerm) {
                filteredProducts = products.filter(product =>
                    product.title.toLowerCase().includes(currentSearchTerm) ||
                    product.category.toLowerCase().includes(currentSearchTerm) ||
                    product.description.toLowerCase().includes(currentSearchTerm)
                );
            }

            // Display message if no products are found
            if (filteredProducts.length === 0) {
                productListContainer.innerHTML = ''; // Clear product list
                noProductsMessage.classList.remove('hidden'); // Show "no products" message
                paginationContainer.innerHTML = ''; // Clear pagination
                return;
            }

            noProductsMessage.classList.add('hidden'); // Hide "no products" message

            // Calculate products for the current page
            const startIndex = (page - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            const pagedProducts = filteredProducts.slice(startIndex, endIndex);

            // Generate HTML for product cards
            productListContainer.innerHTML = pagedProducts.map(product => `
                   <div class="col">
                       <div class="product-card bg-white rounded-lg shadow-lg p-4 flex flex-col justify-between transition-all hover:shadow-xl cursor-pointer" data-product-id="${product.id}">
                           <div class="w-full h-48 mb-4 flex items-center justify-center">
                               <img src="${product.image}" alt="${product.title}" class="max-w-full max-h-full object-contain rounded-md" onerror="this.onerror=null; this.src='https://placehold.co/300x300/E5E7EB/4B5563?text=Image+Not+Available';">
                           </div>
                           <div>
                               <h3 class="text-md font-semibold mb-1 text-gray-800 truncate" title="${product.title}">${product.title}</h3>
                               <p class="text-xs text-gray-500 mb-2 capitalize">${product.category}</p>
                               <p class="text-lg font-bold text-blue-600 mb-3">${formatCurrency(product.price)}</p>
                               <button class="add-to-cart-btn w-full bg-green-500 text-white rounded-md py-2 text-sm hover:bg-green-600 transition-colors flex items-center justify-center gap-2" data-product-id="${product.id}">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/></svg>
                                   Add to Cart
                               </button>
                           </div>
                       </div>
                   </div>`).join('');

            // Add event listeners to product cards and Add to Cart buttons
            productListContainer.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', function(event) {
                    // Prevent opening details modal when clicking the Add to Cart button
                    if (event.target.closest('.add-to-cart-btn')) return;
                    showProductDetails(parseInt(this.dataset.productId)); // Show product details modal
                });
            });

            productListContainer.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const product = products.find(p => p.id === parseInt(this.dataset.productId));
                    if (product) {
                        addToCart(product); // Add product to cart
                    }
                });
            });


            // Calculate total pages for pagination
            totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            renderPagination(currentSearchTerm, currentPage); // Render pagination buttons
        };

        // Render pagination buttons
        const renderPagination = (currentSearchTerm, currentPg) => {
            let paginationHtml = '';
            if (totalPages <= 1) {
                paginationContainer.innerHTML = ''; // Hide pagination if only one page
                return;
            }

            // Logic to determine which page numbers to show
            const maxPagesToShow = 5; // Max number of page buttons to display
            let startPage = Math.max(1, currentPg - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            // Adjust start/end if near the beginning/end of total pages
            if (endPage - startPage + 1 < maxPagesToShow && startPage > 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            if (endPage - startPage + 1 < maxPagesToShow && endPage < totalPages) {
                endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            }

            // Sanitize search term for use in onclick attribute
            const sanitizedSearchTerm = currentSearchTerm.replace(/'/g, "\\'");

            // Add Previous button
            if (currentPg > 1) {
                paginationHtml += `<button class="pagination-button px-3 py-1 border rounded-md hover:bg-gray-200" onclick="changePage('${sanitizedSearchTerm}', ${currentPg - 1})" aria-label="Previous Page">❮</button>`;
            } else {
                paginationHtml += `<button class="pagination-button px-3 py-1 border rounded-md text-gray-400 cursor-not-allowed" disabled aria-label="Previous Page">❮</button>`;
            }

            // Add first page button and ellipsis if needed
            if (startPage > 1) {
                paginationHtml += `<button class="pagination-button px-3 py-1 border rounded-md hover:bg-gray-200" onclick="changePage('${sanitizedSearchTerm}', 1)" aria-label="Page 1">1</button>`;
                if (startPage > 2) {
                    paginationHtml += `<span class="px-3 py-1">...</span>`;
                }
            }

            // Add page number buttons
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPg) {
                    paginationHtml += `<button class="pagination-button px-3 py-1 border rounded-md bg-blue-500 text-white" aria-current="page" aria-label="Page ${i}">${i}</button>`;
                } else {
                    paginationHtml += `<button class="pagination-button px-3 py-1 border rounded-md hover:bg-gray-200" onclick="changePage('${sanitizedSearchTerm}', ${i})" aria-label="Page ${i}">${i}</button>`;
                }
            }

            // Add last page button and ellipsis if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHtml += `<span class="px-3 py-1">...</span>`;
                }
                paginationHtml += `<button class="pagination-button px-3 py-1 border rounded-md hover:bg-gray-200" onclick="changePage('${sanitizedSearchTerm}', ${totalPages})" aria-label="Page ${totalPages}">${totalPages}</button>`;
            }

            // Add Next button
            if (currentPg < totalPages) {
                paginationHtml += `<button class="pagination-button px-3 py-1 border rounded-md hover:bg-gray-200" onclick="changePage('${sanitizedSearchTerm}', ${currentPg + 1})" aria-label="Next Page">❯</button>`;
            } else {
                paginationHtml += `<button class="pagination-button px-3 py-1 border rounded-md text-gray-400 cursor-not-allowed" disabled aria-label="Next Page">❯</button>`;
            }

            paginationContainer.innerHTML = paginationHtml;
        };

        // Global function to change page (called from onclick)
        window.changePage = (currentSearchTerm, page) => {
            currentPage = page;
            renderProducts(currentSearchTerm, currentPage);
            window.scrollTo(0, 0); // Scroll to top on page change
        };


        // Load cart and user from localStorage on page load
        if (localStorage.getItem('cart')) {
            try {
                cartItems = JSON.parse(localStorage.getItem('cart'));
            } catch (error) {
                console.error('Error parsing cart data from localStorage:', error);
                cartItems = []; // Clear cart if data is corrupted
                localStorage.removeItem('cart');
            }
        }
        if (localStorage.getItem('user')) {
            try {
                user = JSON.parse(localStorage.getItem('user'));
            } catch (error) {
                console.error('Error parsing user data from localStorage:', error);
                user = null; // Clear user if data is corrupted
                localStorage.removeItem('user');
            }
        }

        // Save cart/user to localStorage
        const saveCart = () => {
            localStorage.setItem('cart', JSON.stringify(cartItems));
        };
        const saveUser = (currentUser) => {
            localStorage.setItem('user', JSON.stringify(currentUser));
        };

        // --- Event Listeners ---

        // Toggle cart dropdown visibility
        cartContainer.addEventListener('click', (event) => {
            // Prevent closing when clicking inside quantity controls
            if (!event.target.closest('.cart-item button') && !event.target.closest('.cart-item input')) {
                cartDropdown.classList.toggle('hidden');
            }
        });

        // Close cart/user dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            // Close cart dropdown
            if (!cartContainer.contains(event.target) && !cartDropdown.classList.contains('hidden')) {
                cartDropdown.classList.add('hidden');
            }
            // Close user dropdown (if it exists and is visible)
            const userProfileContainer = document.getElementById('user-profile-container');
            if (userDropdown && userProfileContainer && !userDropdown.classList.contains('hidden') && !userProfileContainer.contains(event.target)) {
                userDropdown.classList.add('hidden');
            }
        });

        // Toggle between Sign In and Sign Up forms in the modal
        authToggle.addEventListener('click', (event) => {
            event.preventDefault();
            const isSignIn = authModalLabel.textContent === 'Sign In';
            authModalLabel.textContent = isSignIn ? 'Sign Up' : 'Sign In';
            authSubmitButton.textContent = isSignIn ? 'Sign Up' : 'Sign In';
            nameGroup.style.display = isSignIn ? 'block' : 'none'; // Show name field for Sign Up
            authNameInput.required = isSignIn; // Make name required for Sign Up
            setAuthFormErrors(''); // Clear previous errors
            authForm.reset(); // Reset form fields
        });

        // Toggle user dropdown visibility when clicking the user profile area (if logged in)
        // Check if userProfileContainer exists before adding listener
        const userProfileContainer = document.getElementById('user-profile-container');
        if (userProfileContainer) {
            userProfileContainer.addEventListener('click', (event) => {
                // Only toggle if user is logged in and click is not inside the sign out button
                if (user && (event.target.closest('#user-name') || event.target.closest('#user-email') || event.target === userProfileContainer.querySelector('button:not(#auth-button)'))) {
                    if (userDropdown.contains(event.target) && event.target.id !== 'signout-button') return; // Don't close if clicking inside dropdown but not sign out
                    userDropdown.classList.toggle('hidden');
                }
            });
        }


        // Handle Sign Out
        signOutButton.addEventListener('click', () => {
            user = null; // Clear user state
            localStorage.removeItem('user'); // Remove user from localStorage
            updateAuthUI(); // Update UI to reflect logged-out state
            // Optionally close the user dropdown
            if (userDropdown) userDropdown.classList.add('hidden');
        });

        // Handle Authentication Form Submission (Sign In or Sign Up)
        authForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const isSignIn = authModalLabel.textContent === 'Sign In';
            const name = authNameInput.value.trim();
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value;

            // Basic form validation
            let error = null;
            if (!email) error = 'Email is required';
            else if (!/^\S+@\S+\.\S+$/.test(email)) error = 'Invalid email format';
            else if (!password) error = 'Password is required';
            else if (password.length < 6) error = 'Password must be at least 6 characters';
            else if (!isSignIn && !name) error = 'Name is required'; // Name required only for Sign Up

            if (error) {
                setAuthFormErrors(error);
                return;
            }

            setAuthFormErrors(''); // Clear errors
            authSubmitButton.disabled = true; // Disable button during submission
            authSubmitButton.textContent = isSignIn ? 'Signing In...' : 'Signing Up...';

            // Mock authentication process (replace with actual API calls in a real app)
            setTimeout(() => {
                if (isSignIn) {
                    // Mock Sign In success
                    if (email === 'user@example.com' && password === 'password123') {
                        user = {
                            name: 'Demo User',
                            email: email
                        };
                        saveUser(user);
                        // Close modal using Bootstrap's JS API
                        bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
                        updateAuthUI(); // Update UI
                    } else {
                        setAuthFormErrors('Invalid email or password.');
                    }
                } else {
                    // Mock Sign Up success
                    user = {
                        name: name,
                        email: email
                    };
                    saveUser(user);
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('authModal')).hide();
                    updateAuthUI(); // Update UI
                }

                authSubmitButton.disabled = false; // Re-enable button
                authSubmitButton.textContent = isSignIn ? 'Sign In' : 'Sign Up'; // Restore button text
                authForm.reset(); // Reset form
                nameGroup.style.display = 'none'; // Hide name field
                authModalLabel.textContent = 'Sign In'; // Reset modal title to Sign In
            }, 1000); // Simulate network delay
        });

        // Handle Checkout Button Click (Modified to check login and show customer details form first)
        checkoutButton.addEventListener('click', () => {
            if (cartItems.length === 0) {
                alert('Your cart is empty!'); // Simple alert for empty cart
                return;
            }

            // Check if user is logged in before proceeding
            if (!user) {
                alert('Please sign in or sign up to proceed with the order.');
                // Optionally, trigger the auth modal here:
                // var authModal = new bootstrap.Modal(document.getElementById('authModal'));
                // authModal.show();
                return; // Stop the checkout process
            }

            cartDropdown.classList.add('hidden'); // Hide cart dropdown
            // Hide main product listing and show customer details form
            mainProductListingView.classList.add('hidden');
            productDetailsElement.classList.add('hidden'); // Ensure product details is hidden
            paginationContainer.classList.add('hidden');
            headerControls.classList.add('hidden'); // Hide search, cart, profile from header

            customerDetailsView.classList.remove('hidden'); // Show customer details view
            orderSummaryView.classList.add('hidden'); // Ensure order summary is hidden
            mainHeaderTitle.textContent = "Enter Your Details"; // Update header title
            window.scrollTo(0, 0); // Scroll to top
        });

        // Handle Shipping Info Form Submission (NEW)
        shippingInfoForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const name = customerNameInput.value.trim();
            const houseNo = customerHouseNoInput.value.trim(); // NEW
            const address = customerAddressInput.value.trim();
            const locality = customerLocalityInput.value.trim();
            const district = customerDistrictInput.value.trim(); // NEW
            const state = customerStateInput.value.trim();
            const pincode = customerPincodeInput.value.trim(); // NEW
            const phone = customerPhoneInput.value.trim(); // NEW
            const altPhone = customerAltPhoneInput.value.trim(); // NEW


            // Basic validation for shipping info (Add validation for new fields)
            let error = null;
            if (!name) error = 'Full Name is required';
            else if (!houseNo) error = 'House/Flat Number is required'; // NEW
            else if (!address) error = 'Street Address is required';
            else if (!locality) error = 'Locality is required';
            else if (!district) error = 'District is required'; // NEW
            else if (!state) error = 'State is required';
            else if (!pincode) error = 'Pincode is required'; // NEW
            else if (!/^\d{6}$/.test(pincode)) error = 'Invalid Pincode format (6 digits required)'; // Basic Pincode format check (NEW)
            else if (!phone) error = 'Main Phone Number is required'; // NEW
            else if (!/^\d{10}$/.test(phone)) error = 'Invalid Phone Number format (10 digits required)'; // Basic Phone format check (NEW)
            // Optional alternate phone validation (can be empty)


            if (error) {
                setShippingFormErrors(error);
                return;
            }

            setShippingFormErrors(''); // Clear errors

            // Store customer information (Include new fields)
            customerInfo = {
                name: name,
                houseNo: houseNo, // NEW
                address: address,
                locality: locality,
                district: district, // NEW
                state: state,
                pincode: pincode, // NEW
                phone: phone, // NEW
                altPhone: altPhone // NEW
            };

            // Proceed to order summary
            customerDetailsView.classList.add('hidden'); // Hide customer details view
            orderSummaryView.classList.remove('hidden'); // Show order summary view
            mainHeaderTitle.textContent = "Confirm Your Order"; // Update header title

            renderOrderSummaryPage(customerInfo); // Populate order summary with customer info
            window.scrollTo(0, 0); // Scroll to top
        });

        // Display shipping form errors (NEW)
        const setShippingFormErrors = (message) => {
            if (shippingFormError) {
                shippingFormError.textContent = message;
                shippingFormError.classList.toggle('hidden', !message); // Show/hide based on message presence
            }
        };


        // Handle Edit Shipping Info Button (NEW)
        editShippingInfoBtn.addEventListener('click', () => {
            orderSummaryView.classList.add('hidden'); // Hide order summary
            customerDetailsView.classList.remove('hidden'); // Show customer details form
            mainHeaderTitle.textContent = "Edit Your Details"; // Update header title

            // Populate the form with existing customer info for editing
            if (customerInfo) {
                customerNameInput.value = customerInfo.name;
                customerHouseNoInput.value = customerInfo.houseNo; // NEW
                customerAddressInput.value = customerInfo.address;
                customerLocalityInput.value = customerInfo.locality;
                customerDistrictInput.value = customerInfo.district; // NEW
                customerStateInput.value = customerInfo.state;
                customerPincodeInput.value = customerInfo.pincode; // NEW
                customerPhoneInput.value = customerInfo.phone; // NEW
                customerAltPhoneInput.value = customerInfo.altPhone; // NEW
            }
            window.scrollTo(0, 0); // Scroll to top
        });


        // Handle Clear Cart Button Click
        clearCartButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear your cart?')) { // Confirmation
                clearCart();
                // If on order summary or details page, redirect to home
                if (orderSummaryView.classList.contains('hidden') && customerDetailsView.classList.contains('hidden')) {
                    // Already on main listing, no need to redirect view
                } else {
                    orderSummaryView.classList.add('hidden');
                    customerDetailsView.classList.add('hidden');
                    mainProductListingView.classList.remove('hidden');
                    paginationContainer.classList.remove('hidden');
                    headerControls.classList.remove('hidden');
                    mainHeaderTitle.textContent = "E-Commerce Store";
                    window.scrollTo(0, 0);
                }
            }
        });

        // Handle Search Input
        searchInput.addEventListener('input', (event) => {
            searchTerm = event.target.value.toLowerCase(); // Get search term
            currentPage = 1; // Reset to first page on search
            renderProducts(searchTerm, currentPage); // Re-render products based on search
        });

        // Handle Product Details Modal Close Button
        productDetailsCloseButton.addEventListener('click', () => {
            productDetailsElement.classList.add('hidden'); // Hide modal
            productDetailsElement.classList.remove('flex'); // Remove flex display
            document.body.style.overflow = ''; // Restore body scrolling
            productDetails = null; // Clear product details state
            resetReviewForm(); // Reset review form
        });

        // Handle Star Rating Selection
        starRatingInputs.forEach(input => {
            input.addEventListener('change', function() {
                selectedRating = parseInt(this.value); // Store selected rating
            });
        });

        // Handle Submit Review Button Click
        submitReviewButton.addEventListener('click', () => {
            const reviewText = reviewInput.value.trim();
            if (!reviewText) {
                alert('Please write a review before submitting.');
                return;
            }
            if (selectedRating === 0) {
                alert('Please select a star rating.');
                return;
            }
            if (!productDetails) {
                alert('Cannot submit review: product details not loaded.');
                return;
            }

            // Create new review object
            const newReview = {
                user: user ? user.name : 'Anonymous', // Use logged-in user name or 'Anonymous'
                rating: selectedRating,
                comment: reviewText,
                date: new Date().toLocaleDateString() // Add current date
            };

            // Add review to the productDetails object and the corresponding product in the main products array
            if (!productDetails.reviews || !Array.isArray(productDetails.reviews)) {
                productDetails.reviews = [];
            }
            productDetails.reviews.unshift(newReview); // Add to the beginning of the reviews list

            // Find the product in the main products array and update its reviews
            const productInList = products.find(p => p.id === productDetails.id);
            if (productInList) {
                if (!productInList.reviews || !Array.isArray(productInList.reviews)) {
                    productInList.reviews = [];
                }
                productInList.reviews.unshift(newReview);
                // Note: In a real app, you would also update the product data on the server
            }

            renderProductDetailsReviews(productDetails.reviews); // Re-render reviews in the modal
            alert('Thank you for your review!'); // Confirmation message
            resetReviewForm(); // Clear the review form
        });

        // Reset the review form fields and rating
        function resetReviewForm() {
            reviewInput.value = '';
            starRatingInputs.forEach(input => input.checked = false);
            selectedRating = 0;
        }

        // --- Cart Functions ---

        // Add a product to the cart
        const addToCart = (productToAdd) => {
            if (!productToAdd || typeof productToAdd.id === 'undefined') {
                console.error('Invalid product:', productToAdd);
                alert('Error adding item.');
                return;
            }
            const existingItem = cartItems.find((item) => item.id === productToAdd.id);
            if (existingItem) {
                existingItem.quantity += 1; // Increment quantity if item already exists
            } else {
                cartItems.push({
                    ...productToAdd,
                    quantity: 1
                }); // Add new item with quantity 1
            }
            saveCart(); // Save updated cart to localStorage
            updateCartUI(); // Update the cart display
            alert(`${productToAdd.title} added to cart!`); // User feedback
        };

        // Remove a product from the cart
        const removeFromCart = (productId) => {
            cartItems = cartItems.filter((item) => item.id !== productId); // Filter out the item
            saveCart(); // Save updated cart
            updateCartUI(); // Update cart display
        };

        // Update the quantity of a product in the cart
        const updateQuantity = (productId, quantity) => {
            const item = cartItems.find((item) => item.id === productId);
            if (item) {
                item.quantity = Math.max(0, quantity); // Ensure quantity is not negative
                if (item.quantity === 0) {
                    removeFromCart(productId); // Remove item if quantity becomes 0
                } else {
                    saveCart(); // Save updated cart
                    updateCartUI(); // Update cart display
                }
            }
        };

        // Clear all items from the cart
        const clearCart = () => {
            cartItems = []; // Empty the cart array
            saveCart(); // Save empty cart
            updateCartUI(); // Update cart display
        };

        // Update the visual display of the cart (dropdown content, total, item count)
        const updateCartUI = () => {
            // Guard clause in case the cart container is not in the current view
            if (!cartItemsContainer) return;

            if (cartItems.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-500">Your cart is empty.</p>';
            } else {
                cartItemsContainer.innerHTML = cartItems.map(item => `
                       <div class="cart-item flex items-center justify-between border-b border-gray-200 py-2 last:border-b-0">
                           <div class="flex items-center gap-3">
                               <img src="${item.image}" alt="${item.title}" class="w-12 h-12 object-contain rounded-md" onerror="this.onerror=null; this.src='https://placehold.co/48x48/E5E7EB/4B5563?text=No+Img';">
                               <div class="flex-grow"><h4 class="text-sm font-semibold truncate w-40" title="${item.title}">${item.title}</h4><p class="text-xs text-gray-500">Price: ${formatCurrency(item.price)}</p>
                                   <div class="flex items-center gap-2 mt-1">
                                       <button class="text-xs bg-gray-200 hover:bg-gray-300 rounded-md px-2 py-0.5 leading-none" onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                                       <span class="text-sm">${item.quantity}</span>
                                       <button class="text-xs bg-gray-200 hover:bg-gray-300 rounded-md px-2 py-0.5 leading-none" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                                   </div></div></div>
                           <button class="text-red-500 hover:text-red-700 p-1" onclick="removeFromCart(${item.id})" title="Remove item"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                       </div>`).join('');
            }
            // Calculate and display total price
            const total = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);
            cartTotalPriceElement.textContent = formatCurrency(total);
            // Calculate and display total item count
            cartItemCountElement.textContent = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            // Enable/disable checkout and clear cart buttons based on cart contents
            checkoutButton.disabled = cartItems.length === 0;
            clearCartButton.disabled = cartItems.length === 0;
        };

        // --- Authentication UI Functions ---

        // Update the header UI based on user login status
        const updateAuthUI = () => {
            // Check if user is logged in
            if (user) {
                // If logged in, hide auth button and show user dropdown
                if (authButton) authButton.classList.add('hidden');
                if (userDropdown) {
                    userDropdown.classList.remove('hidden');
                    userNameElement.textContent = user.name; // Display user name
                    userEmailElement.textContent = user.email; // Display user email
                }
            } else {
                // If logged out, show auth button and hide user dropdown
                if (authButton) authButton.classList.remove('hidden');
                if (userDropdown) userDropdown.classList.add('hidden');
            }
            // Update cart UI as well, as it might depend on user status (though not in this mock)
            updateCartUI();
        };

        // Display authentication form errors
        const setAuthFormErrors = (message) => {
            const errorElement = document.getElementById('auth-error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.toggle('hidden', !message); // Show/hide based on message presence
            }
        };



        // Show product details modal
        const showProductDetails = (productId) => {
            const product = products.find((p) => p.id === productId);
            if (!product) {
                console.error("Product not found:", productId);
                alert("Product details not loaded.");
                return;
            }
            productDetails = product; // Store current product details
            renderProductDetails(product); // Populate modal content
            productDetailsElement.classList.remove('hidden'); // Show modal
            productDetailsElement.classList.add('flex'); // Use flexbox for centering
            document.body.style.overflow = 'hidden'; // Prevent body scrolling when modal is open
        };

        // Populate product details modal with product data
        const renderProductDetails = (product) => {
            if (!product) return;

            // Ensure product.images is an array, fallback to product.image if needed
            if (product.image && !product.images) {
                product.images = [product.image];
            } else if (!product.images) {
                product.images = [];
            }


            // Render thumbnail images with Error Handling
            if (product.images.length > 0) {
                productDetailsImagesContainer.innerHTML = product.images.map((image, index) =>
                    `<img src="${image}" alt="Product thumbnail ${index + 1}" onclick="switchMainImage('${image}')" class="w-16 h-16 object-contain rounded-md border-2 border-transparent hover:border-blue-500 p-0.5 cursor-pointer" onerror="this.onerror=null; this.src='https://placehold.co/64x64/E5E7EB/4B5563?text=No+Img';">`
                ).join('');
                // Set the first image as the main image initially
                productDetailsMainImage.src = product.images[0];
                productDetailsMainImage.alt = product.title;
            } else {
                // Display placeholder if no images
                productDetailsImagesContainer.innerHTML = '<p class="text-gray-500 text-sm">No images available.</p>';
                productDetailsMainImage.src = 'https://placehold.co/300x300/E5E7EB/4B5563?text=No+Image'; // Tailwind gray-200 bg, gray-600 text
                productDetailsMainImage.alt = 'No image';
            }

            // Populate other product details
            productDetailsTitleElement.textContent = product.title;
            productDetailsDescriptionElement.textContent = product.description;
            productDetailsPriceElement.textContent = formatCurrency(product.price);
            productDetailsRatingElement.textContent = product.rating ? `${product.rating.rate} (${product.rating.count} reviews)` : 'N/A';
            // Seller is hardcoded as 'Example Seller' in the HTML, could be dynamic if data included it

            // Render reviews
            renderProductDetailsReviews(product.reviews);
            resetReviewForm(); // Reset review form when opening details
        };

        // Render the list of reviews in the product details modal
        function renderProductDetailsReviews(reviews) {
            if (reviews && Array.isArray(reviews) && reviews.length > 0) {
                productDetailsReviewsContainer.innerHTML = reviews.map(review => `
                       <div class="review-item border-b border-gray-200 pb-2 mb-2 last:border-b-0 last:mb-0">
                           <div class="flex items-center justify-between text-sm mb-1">
                               <span class="font-semibold text-gray-700">${review.user || 'Anonymous'}</span>
                               <span class="text-yellow-500">${'★'.repeat(Math.round(review.rating || 0))}${'☆'.repeat(5 - Math.round(review.rating || 0))}</span>
                           </div>
                           <p class="text-gray-600 text-sm">${review.comment}</p>
                           ${review.date ? `<p class="text-xs text-gray-400 mt-1">${review.date}</p>` : ''}
                       </div>`).join('');
            } else {
                productDetailsReviewsContainer.innerHTML = '<p class="text-gray-500 text-sm">No reviews yet.</p>';
            }
        }

        // Global function to switch the main image in the product details modal (called from onclick)
        window.switchMainImage = (imageUrl) => {
            productDetailsMainImage.src = imageUrl;
            // Add error handling to the main image when switching
            productDetailsMainImage.onerror = function() {
                this.onerror = null; // Prevent infinite loop if placeholder also fails
                this.src = 'https://placehold.co/300x300/E5E7EB/4B5563?text=Image+Not+Available';
            };
        };

        // --- Order Summary Page Functions ---

        // Render the content of the order summary page (Modified to accept customer info)
        function renderOrderSummaryPage(customerInfo) {
            const currentCartItems = JSON.parse(localStorage.getItem('cart')) || [];
            let subtotal = 0;
            orderItemsSummaryContainer.innerHTML = ''; // Clear previous summary items

            // Display message if the order is empty (shouldn't happen if checkout button is disabled correctly)
            if (currentCartItems.length === 0) {
                orderItemsSummaryContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">Your order is empty. Please continue shopping.</p>';
                summarySubtotalEl.textContent = formatCurrency(0);
                summaryTaxEl.textContent = formatCurrency(0);
                summaryTotalEl.textContent = formatCurrency(0);
                proceedToPaymentBtn.disabled = true; // Disable payment button
                customerSummaryDetails.classList.add('hidden'); // Hide customer details if order is empty
                return;
            }

            proceedToPaymentBtn.disabled = false; // Enable payment button if items exist

            // Display customer details in summary (NEW)
            if (customerInfo) {
                customerSummaryDetails.classList.remove('hidden');
                summaryCustomerNameEl.textContent = customerInfo.name;
                summaryCustomerHouseNoEl.textContent = customerInfo.houseNo; // NEW
                summaryCustomerAddressEl.textContent = customerInfo.address;
                summaryCustomerLocalityEl.textContent = customerInfo.locality;
                summaryCustomerDistrictEl.textContent = customerInfo.district; // NEW
                summaryCustomerStateEl.textContent = customerInfo.state;
                summaryCustomerPincodeEl.textContent = customerInfo.pincode; // NEW
                summaryCustomerPhoneEl.textContent = customerInfo.phone; // NEW
                summaryCustomerAltPhoneEl.textContent = customerInfo.altPhone || 'N/A'; // NEW (Handle optional field)
            } else {
                customerSummaryDetails.classList.add('hidden'); // Hide if no customer info
            }


            // Add each item to the order summary list with Error Handling for images
            currentCartItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'flex justify-between items-start border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:mb-0';
                itemEl.innerHTML = `
                   <div class="flex items-start gap-4">
                       <img src="${item.image}" alt="${item.title}" class="w-20 h-20 object-contain rounded-md border p-1" onerror="this.onerror=null; this.src='https://placehold.co/80x80/E5E7EB/4B5563?text=No+Img';">
                       <div>
                           <p class="font-medium text-gray-800">${item.title}</p>
                           <p class="text-sm text-gray-500">Qty: ${item.quantity}</p>
                           <p class="text-sm text-gray-500">Unit Price: ${formatCurrency(item.price)}</p>
                       </div>
                   </div>
                   <div class="text-gray-800 font-medium text-right">${formatCurrency(item.price * item.quantity)}</div>
               `;
                orderItemsSummaryContainer.appendChild(itemEl);
                subtotal += item.price * item.quantity; // Calculate subtotal
            });

            // Calculate tax and total
            const taxRate = 0.05; // 5% tax rate
            const tax = subtotal * taxRate;
            const total = subtotal + tax;

            // Display summary totals
            summarySubtotalEl.textContent = formatCurrency(subtotal);
            summaryTaxEl.textContent = formatCurrency(tax);
            summaryTotalEl.textContent = formatCurrency(total);
        }

        // Handle Continue Shopping button click on order summary page
        continueShoppingBtn.addEventListener('click', () => {
            orderSummaryView.classList.add('hidden'); // Hide order summary
            customerDetailsView.classList.add('hidden'); // Ensure customer details is hidden
            mainProductListingView.classList.remove('hidden'); // Show product listing
            paginationContainer.classList.remove('hidden'); // Show pagination
            headerControls.classList.remove('hidden'); // Restore header controls
            mainHeaderTitle.textContent = "E-Commerce Store"; // Restore header title
            window.scrollTo(0, 0); // Scroll to top
        });

        // Handle Proceed to Payment button click on order summary page (Mock)
        proceedToPaymentBtn.addEventListener('click', () => {
            // In a real application, you would send the cartItems and customerInfo to a backend
            // for processing payment and creating the order.
            alert('Payment Successful! Thank you for your order.\n(This is a mock process and your cart will now be cleared)');
            clearCart(); // Clear the cart after mock payment
            customerInfo = null; // Clear customer info after order

            // Navigate back to shopping view
            orderSummaryView.classList.add('hidden');
            customerDetailsView.classList.add('hidden'); // Ensure customer details is hidden
            mainProductListingView.classList.remove('hidden');
            paginationContainer.classList.remove('hidden');
            headerControls.classList.remove('hidden');
            mainHeaderTitle.textContent = "E-Commerce Store";
            window.scrollTo(0, 0);
        });


        // --- Initialization ---

        // Function to fetch products and initialize the app
        const initializeApp = () => {
            fetch(`${API_BASE_URL}/products`)
                .then(response => {
                    if (!response.ok) {
                        // Handle HTTP errors
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Process fetched product data
                    products = data.map(p => ({
                        ...p,
                        // Ensure images is an array, fallback to image if needed
                        images: p.image ? [p.image] : (p.images || []),
                        reviews: p.reviews || [] // Ensure reviews is an array
                    }));
                    // Render the initial product list
                    renderProducts(searchTerm, currentPage);
                    // Update UI based on authentication status
                    updateAuthUI();
                })
                .catch(error => {
                    // Handle errors during product fetching
                    console.error("Failed to fetch products:", error);
                    // Display an error message to the user
                    productListContainer.innerHTML = `<div class="col-span-full text-center text-red-500 p-10"><p class="text-xl">Oops! Something went wrong.</p><p>Error: ${error.message}</p></div>`;

                    // Also add a more prominent error message above the main content
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'container mx-auto text-center text-red-500 p-4 bg-red-100 border border-red-500 rounded-md';
                    errorDiv.innerHTML = `<p><strong>Error:</strong> ${error.message}. Products could not be loaded.</p>`;
                    const mainElement = document.querySelector('#main-product-listing-view') || document.getElementById('root');
                    // Insert the error message before the main content or root
                    if (mainElement && mainElement.parentNode) {
                        mainElement.parentNode.insertBefore(errorDiv, mainElement);
                    } else {
                        // Fallback if mainElement or its parent is not found
                        document.body.insertBefore(errorDiv, document.body.firstChild);
                    }
                    // Ensure pagination and product list areas are cleared on error
                    productListContainer.innerHTML = '';
                    paginationContainer.innerHTML = '';
                    noProductsMessage.classList.remove('hidden'); // Show 'no products' message
                });
        };

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>

</html>